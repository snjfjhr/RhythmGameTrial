<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Rhythm Game</title>
<style>
  body {
    margin: 0;
    overflow: hidden;
    touch-action: manipulation;
  }
  #gameCanvas {
    background: #111;
    display: block;
    margin: 0 auto;
  }

  #startButton, #retryButton {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 24px;
    font-size: 20px;
    background: #fff;
    border-radius: 8px;
    cursor: pointer;
  }

  #startButton {
    top: 40%;
  }
  #retryButton {
    top: 50%;
    display: none;
  }
</style>
</head>
<body>

<canvas id="gameCanvas"></canvas>
<div id="startButton">Start</div>
<div id="retryButton">Retry</div>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 600;
canvas.height = 800;

let notes = [];
let isPlaying = false;
let startTime = 0;
let lineY = 700; // 判定ライン

function spawnNotes() {
  notes = [];
  for (let i = 0; i < 10; i++) {
      notes.push({
          x: 300,
          y: -100 - i * 200,
          time: i * 1000
      });
  }
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 判定ライン
  ctx.fillStyle = "red";
  ctx.fillRect(0, lineY, canvas.width, 4);

  notes.forEach(note => {
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(note.x, note.y, 20, 0, Math.PI * 2);
    ctx.fill();
  });

  if (isPlaying) requestAnimationFrame(draw);
}

function update() {
  if (!isPlaying) return;

  const elapsed = performance.now() - startTime;

  notes.forEach(note => {
    note.y = (elapsed - note.time) * 0.3;
  });

  requestAnimationFrame(update);
}

function checkHit(inputY) {
  for (let note of notes) {
    const diff = Math.abs(note.y - lineY);
    if (diff < 25) {
      console.log("PERFECT");
      note.y = 9999;
      return;
    }
  }
  console.log("MISS");
}

// -------- input events (PC + Mobile) ----------
document.addEventListener("keydown", (e) => {
  if (e.code === "Space") checkHit();
});

// ★ スマホ用タップイベント
canvas.addEventListener("touchstart", (e) => {
  e.preventDefault();
  const touch = e.changedTouches[0];

  // キャンバス座標に変換（必要ならオフセット調整）
  const rect = canvas.getBoundingClientRect();
  const y = touch.clientY - rect.top;

  checkHit(y);
}, { passive: false });

// PCマウスにも対応（保険）
canvas.addEventListener("mousedown", (e) => {
  const rect = canvas.getBoundingClientRect();
  const y = e.clientY - rect.top;
  checkHit(y);
});

// -------- Buttons ----------
const startButton = document.getElementById("startButton");
const retryButton = document.getElementById("retryButton");

startButton.onclick = () => {
  startButton.style.display = "none";
  retryButton.style.display = "none";
  startGame();
};

retryButton.onclick = () => {
  retryButton.style.display = "none";
  startGame();
};

function startGame() {
  spawnNotes();
  isPlaying = true;
  startTime = performance.now();
  draw();
  update();
}
</script>

</body>
</html>
